# Puzzle AI Canvas-First 计划（2025-11-29）

> 聚焦 Home Canvas：fragment dumping、context 管理（summary/tag/cluster）、puzzle summary card、mascot 入口与 AI orchestration；Puzzle Session 内部交互仅保留接口占位，后续再做。

## 现状快照（code vs SystemDoc/AgentAndContext）
- 仅有基础 Canvas：TEXT/IMAGE/FRAME fragment 创建拖拽；TopBar brief 输入但未入持久 store；PuzzleDeck/AI 入口为 mock；无 mascot、无 fragment summary/tag/cluster、无 puzzle summary card。
- 状态管理全部在 `App.tsx` useState；无 ProjectStore、无 UIEvent/PieceEvent、无 PreferenceProfile、无 persistence/undo/redo。
- AI 仅 `services/geminiService.ts` 单次 Lever 检测；未按五类 agents 与 orchestrator。

## Canvas 层核心缺口
- **Process Aim 常驻**：顶栏 brief 写入 ProjectStore，所有 AI 调用的长程上下文。
- **Fragment 语义层**：summary/tag、cluster（theme + fragmentIds）、label 与 puzzle 关联；需要 debounced FRAGMENT_* → Fragment & Context Agent。
- **Puzzle Summary Cards**：puzzle 完结后在 Canvas 落卡片，给相关 fragment 加 color label/links（多对多）。
- **Mascot 入口**：Guide 提示 + puzzle launcher（start from my question / suggest puzzle），与 orchestrator 事件流。
- **Context Store & 事件**：ProjectStore schema、UIEvent/PieceEvent 记录、undo/redo stack、轻量持久化（IndexedDB/localStorage）。
- **AI 编排**：Orchestrator 裁剪 context 调 agents，schema 校验、fallback；Google ADK/Gemini 3 客户端封装。

## Skeleton 模块（interface-first）
- **domain/models**（TypeScript）  
  `Project`, `Fragment`, `FragmentLink`, `Cluster`, `Puzzle`, `PuzzleSummary`, `UIEvent`, `PieceEvent`, `UserPreferenceProfile`; 枚举 `DesignMode`, `PuzzlePieceCategory`, `PieceStatus`, `AnchorType`（puzzle session 相关仅占位）。
- **store/context-store**  
  ProjectStore 读写器（内存 + IndexedDB fallback），API：`load/save`, `updateProcessAim`, `upsertFragment`, `upsertCluster`, `addPuzzleSummary`, `labelFragments`, `setPreferenceProfile`；带 undo/redo stack。
- **store/event-bus**  
  UIEvent emitter（FRAGMENT_*、MASCOT_CLICKED、PUZZLE_FINISH_CLICKED stub）；orchestrator 订阅；FRAGMENT_* debounce 聚合。
- **store/preference-profile**  
  聚合 PieceEvent → PreferenceStats；生成 `preferenceHints` 文本（供 Mascot/Piece agent），即使 puzzle UI 未就绪也先存数据。
- **frontend/home-canvas**  
  画布 + Fragment 组件接入 store/event；Process Aim pill 双向绑定；summary/tag 展示 placeholder；cluster overlay/颜色标签占位；Puzzle Summary Card 组件；mascot 入口按钮/面板。
- **frontend/mascot-panel**  
  Guide/Puzzle Launcher/Reflection UI 壳；点击触发 MASCOT_CLICKED；显示 proposal（centralQuestion/primaryModes/rationale）或 reflection；可先用 mock orchestrator。
- **ai/orchestrator**  
  事件驱动 reducer；context 裁剪（Process Aim + fragments + clusters + puzzleSummaries + preferenceHints）；调用 agents；zod/schema 校验；写回 store；错误 fallback（toast/标记）。
- **ai/agents**  
  Fragment & Context Agent（summary/tag/cluster）；Mascot Agent（self-raised/suggest）；Puzzle Designer Agent（design/summarize，设计任务可仅生成 anchors/seedPieces stub，summarize 用于 summary card）；Quadrant Piece Agent 占位；prompt 放 `ai/prompts/*.tmpl`。
- **services/adk-client**  
  Google ADK/Gemini 3 包装（model/temperature/timeout/safety、retry、mock mode）。
- **docs**  
  `docs/STATE.md`（ProjectStore schema + event 定义），`docs/AI-FLOWS.md`（仅 Canvas 相关 Flow：Fragments→Context、Self/Suggest puzzle→summary card），注明 puzzle session 内部 “deferred”。
- **tests**  
  table-driven：orchestrator reducer、ProjectStore mutate/undo-redo、preference 聚合、prompt 输出 schema 校验（mock LLM fixtures）。

## 渐进里程碑（Canvas-first slices）
1) **Types + Store**：落地 domain models；实现 ProjectStore（内存 + undo/redo），将现有 Canvas state 接入 store。
2) **Event Bus + Aim 管线**：UIEvent emitter/subscribe；Process Aim pill 写入 store；FRAGMENT_* 事件贯通。
3) **Fragment 语义化**：接 Fragment & Context Agent（可 mock），显示 summary/tag，占位 cluster overlay；FRAGMENT_* debounce。
4) **Puzzle Summary Card & Label**：模拟 PUZZLE_FINISH_CLICKED → Puzzle Designer summarize → 在 Canvas 渲染卡片并为 fragment 上色/打 label。
5) **Mascot Launcher**：UI 壳 + MASCOT_CLICKED → orchestrator → Mascot Agent（self/suggest） → 展示 centralQuestion/primaryModes/rationale；可用 mock data。
6) **AI 接线**：引入 Google ADK 客户端、prompt 模板、zod/schema 校验、错误 fallback；替换 mock。
7) **Persistence & Preference**：IndexedDB 落地；PieceEvent & PreferenceProfile 聚合（即便 puzzle UI 未完，保留通路）；调试/日志面板。

## TODO 追踪
- [x] 定义 domain models（ProjectStore/Fragment/Puzzle 等）并落文件。
- [x] ContextStore 骨架：undo/redo、persistence hook、CRUD helpers。
- [x] 事件总线 + PreferenceProfile 聚合接口（只骨架，待接 UI）。
- [x] Process Aim 管线：TopBar 输入写入 store，事件广播（当前写入 store，后续可广播）。
- [x] Fragment 语义化：FRAGMENT_* debounce → Fragment & Context Agent（mock）→ summary/tag/cluster 渲染。
- [ ] Puzzle Summary Card 占位：PUZZLE_FINISH_CLICKED stub → summary card + fragment label。
- [ ] Mascot Launcher 壳：MASCOT_CLICKED → orchestrator → proposal 展示（UI 待做）。
- [ ] ADK 接线：Google ADK client + prompt 模板 + schema 校验 + fallback（adkClient/agents 已建，待 schema）。
- [ ] Persistence 落地：IndexedDB/localStorage adapter，实现 persist/hydrate；偏好聚合闭环。
- [ ] Fragment 删除/快捷键：UI 删除、事件同步（已接入 state，后续接 eventBus 标准化）。
- [ ] 调试：确保 PUZZLE_FINISH_CLICKED 流程更新 puzzleSummaries/UI（logs 已加，需确认 eventBus/orchestrator 链路）。
- [x] Mascot Launcher 壳：UI + orchestrator proposal/suggestion 展示。
- [x] Cluster overlay & puzzle deck finish 按钮；labels 显示在 fragment。
- [x] localStorage Adapter 及 auto-persist（contextStore commit 调 persist）。
